<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>منصة إسلامية متكاملة</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1220; --fg:#eef2ff; --muted:#94a3b8; --card:#111a2e; --brand:#0ea37a; --brand-2:#22d3ee; --brand-3:#8b5cf6;
  --shadow:0 8px 30px rgba(0,0,0,.4);
}
*{box-sizing:border-box}
body{margin:0;font-family:'Cairo',system-ui,Segoe UI,Arial; background:var(--bg); color:var(--fg);}
a{color:inherit}
.container{max-width:1100px;margin:auto;padding:16px;}
.nav{position:sticky;top:0;z-index:30;background:rgba(0,0,0,.5);backdrop-filter:blur(10px);border-bottom:1px solid #1f2937}
.nav .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.logo{display:flex;gap:8px;align-items:center;font-weight:700}
.badge{font-size:.78rem;border:1px solid #334155;border-radius:999px;padding:.2rem .6rem;color:#cbd5e1}
.tab{padding:.55rem .9rem;border-radius:999px;border:1px solid #334155;cursor:pointer;user-select:none}
.tab.active{background:linear-gradient(135deg,var(--brand),#22c55e); border-color:transparent; color:white; box-shadow:var(--shadow)}
select,button,input{font-family:inherit}
.btn{background:linear-gradient(135deg,var(--brand),#22c55e); border:0; color:white; padding:.7rem 1rem; border-radius:12px; cursor:pointer; box-shadow:var(--shadow)}
.btn.sm{padding:.4rem .7rem;border-radius:10px}
.field{background:#0b1324;border:1px solid #334155;color:var(--fg);padding:.6rem .7rem;border-radius:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
.card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px;box-shadow:var(--shadow)}
.heading{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.muted{color:var(--muted);font-size:.92rem}
main section{display:none}
main section.active{display:block;animation:fade .35s ease}
@keyframes fade{from{opacity:.2;transform:translateY(6px)}to{opacity:1;transform:none}}

.hero{position:relative;border-radius:16px;overflow:hidden;min-height:180px;background:linear-gradient(180deg,rgba(14,163,122,.3), transparent), url('https://images.unsplash.com/photo-1549880338-65ddcdfd017b?q=80&w=1600&auto=format&fit=crop') center/cover}
.hero .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.2),rgba(0,0,0,.7));}
.hero .inner{position:relative;padding:28px}
.kpi{display:flex;gap:12px;align-items:center}
.kpi .num{font-size:1.6rem;font-weight:700}

.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.pill{display:flex;align-items:center;gap:8px;background:#0b1324;border:1px solid #334155;padding:.4rem .6rem;border-radius:999px}
.bad-surface{background:#0b1324;border:1px dashed #334155;border-radius:16px;padding:14px;text-align:center}

.footer{opacity:.8;font-size:.9rem;margin:28px 0;text-align:center}
.toast{position:fixed;bottom:18px;right:18px;background:#111827;color:#fff;padding:.7rem 1rem;border-radius:10px;box-shadow:var(--shadow);opacity:0;transform:translateY(10px);transition:.25s;z-index:50}
.toast.on{opacity:1;transform:none}
.mini{position:fixed;left:12px;bottom:12px;z-index:40;background:rgba(0,0,0,.5);backdrop-filter:blur(10px);border:1px solid #1f2937;border-radius:12px;padding:10px;display:none;gap:10px;align-items:center}
.mini.on{display:flex}
.mini audio{width:200px}
.theme{display:flex;gap:6px}
.swatch{width:26px;height:26px;border-radius:999px;border:2px solid #1f2937;cursor:pointer}
.swatch.green{background:#0ea37a}.swatch.cyan{background:#22d3ee}.swatch.violet{background:#8b5cf6}
.ayah:hover{background:rgba(148,163,184,.15)}
</style>
</head>
<body>
  <div class="nav">
    <div class="container">
      <div class="row">
        <div class="logo">🕋 منصة إسلامية <span class="badge">نسخة أولية</span></div>
        <div class="row" id="tabs">
          <div class="tab active" data-to="home">الرئيسية</div>
          <div class="tab" data-to="prayer">مواقيت الصلاة</div>
          <div class="tab" data-to="live">البث المباشر</div>
          <div class="tab" data-to="mushaf">المصحف</div>
          <div class="tab" data-to="azkar">الأذكار</div>
          <div class="tab" data-to="fav">المفضلة</div>
          <div class="tab" data-to="search">البحث</div>
        </div>
        <div style="margin-inline-start:auto" class="theme">
          <span class="swatch green" data-theme="green" title="أخضر"></span>
          <span class="swatch cyan" data-theme="cyan" title="أزرق سماوي"></span>
          <span class="swatch violet" data-theme="violet" title="بنفسجي"></span>
        </div>
      </div>
    </div>
  </div>

  <main class="container">
    <section id="home" class="active">
      <div class="hero">
        <div class="overlay"></div>
        <div class="inner">
          <h1>بوابة موحدة: القرآن • المواقيت • البث • الأذكار</h1>
          <p class="muted" id="dateTime"></p>
<script>
function updateDateTime(){
  const now = new Date();
  const opts = {weekday:'long', year:'numeric', month:'long', day:'numeric'};
  const miladi = now.toLocaleDateString('ar-EG', opts);
  const time12 = now.toLocaleTimeString('ar-EG', {hour:'numeric', minute:'2-digit', second:'2-digit', hour12:true});
  const hijri = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', opts).format(now);
  document.getElementById('dateTime').textContent = `📅 ${hijri} • ${miladi} — 🕒 ${time12}`;
}
setInterval(updateDateTime,1000);
updateDateTime();
</script>
          <div class="row" style="margin-top:8px">
            <button class="btn" onclick="gotoSection('prayer')">اذهب لمواقيت الصلاة</button>
            <button class="btn" onclick="gotoSection('mushaf')">افتح المصحف</button>
          </div>
        </div>
      </div>
      <div class="grid" style="margin-top:14px">
        <div class="card">
          <div class="heading"><b>آية اليوم</b><span class="badge">قرآن كريم</span></div>
          <p id="ayahOfDay" style="font-size:1.15rem;line-height:2"></p>
        </div>
        <div class="card">
          <div class="heading"><b>ذِكر اليوم</b><span class="badge">تشغيل صوتي</span></div>
          <p id="zekrOfDay" style="line-height:2"></p>
          <div class="row"><button class="btn sm" onclick="speak(document.getElementById('zekrOfDay').textContent)">تشغيل</button></div>
        </div>
      </div>
    </section>

    <section id="prayer">
      <div class="heading"><b>مواقيت الصلاة</b><span class="badge" id="locBadge">—</span></div>
      <div class="grid">
        <div class="card">
          <div class="row">
            <input class="field" id="cityInput" placeholder="حدد مدينة أو فعّل الموقع"/>
            <button class="btn sm" id="useGeo">الموقع التلقائي</button>
          </div>
          <div id="timesWrap" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr));margin-top:10px"></div>
          <div class="bad-surface"><b>العد التنازلي:</b> <span id="nextName">—</span> • <span id="countdown">--:--:--</span></div>
        </div>
        <div class="card">
          <div class="heading"><b>🔔 التنبيهات</b><span class="badge">قبل 15د • بعد 20د</span></div>
          <div class="row">
            <label class="pill"><input type="checkbox" id="remindersToggle"> تفعيل</label>
            <label class="pill">قبل الصلاة <input class="field" id="preMinutes" type="number" min="1" max="120" value="15" style="width:80px"></label>
            <label class="pill">بعد الصلاة <input class="field" id="postMinutes" type="number" min="1" max="120" value="20" style="width:80px"></label>
            <button class="btn sm" id="saveReminders">حفظ</button>
          </div>
          <p class="muted">سيظهر إشعار أنيق يذكرك بالصلاة القادمة وبأذكار ما بعد الصلاة — يدعم الوضع الليلي 🌙</p>
        </div>
      </div>
    </section>

    <section id="live">
      <div class="heading"><b>البث المباشر</b><span class="badge">صوت فقط • مشغّل عائم</span></div>
      <div class="card">
        <div class="row">
          <select class="field" id="radioSel"></select>
          <input id="customUrl" class="field" placeholder="أو ضع رابط إذاعة مباشر HTTPS" style="flex:1">
          <button class="btn sm" id="playRadio">تشغيل</button>
        </div>
        <audio id="radio" controls style="width:100%;margin-top:8px"></audio>
        <p class="muted">مصادر جاهزة: إذاعة القرآن الكريم من القاهرة، إذاعة القرآن السعودية، محطات Qurango المتعددة.</p>
      </div>
    </section>

    <section id="mushaf">
      <div class="heading"><b>المصحف</b><span class="badge">نص عثماني + تلاوات كاملة</span></div>
      <div class="card">
        <div class="row">
          <select class="field" id="surahSel"></select>
          <select class="field" id="reciterSel"></select>
          <button class="btn sm" id="playSurah">تشغيل السورة كاملة</button>
        </div>
<div class="row" style="margin-top:8px">
  <label class="pill"><input type="checkbox" id="byAyah"> تشغيل آية-بآية</label>
  <select id="tafsirSel" class="field">
    <option value="">بدون تفسير</option>
    <option value="ar.jalalayn">الجلالين</option>
    <option value="ar.ibnkatheer">ابن كثير</option>
  </select>
</div>

        <div id="qText" style="line-height:2;margin-top:8px"></div>
<div id="tafsirBox" class="card" style="margin-top:10px;display:none">
  <div class="heading"><b>📚 التفسير</b></div>
  <div id="tafsirContent" class="muted" style="line-height:2"></div>
</div>
<audio id="qAudio"  controls style="width:100%;margin-top:8px"></audio>
      </div>
    </section>

    <section id="azkar">
      <div class="heading"><b>الأذكار</b><span class="badge">بطاقات مع عداد تكرار</span></div>
      <div class="row" style="margin-bottom:8px">
        <select id="azCat" class="field">
          <option value="morning">أذكار الصباح</option>
          <option value="evening">أذكار المساء</option>
          <option value="afterSalah">أذكار بعد الصلاة</option>
          <option value="ruqyah">الرُّقية الشرعية</option>
          <option value="sleep">أذكار النوم</option>
          <option value="wudu">أذكار الوضوء</option>
        </select>
        <button class="btn sm" onclick="startAuto()">وضع القراءة المستمر</button>
      </div>
      <div id="azList" class="grid"></div>
    </section>

    <section id="fav">
      <div class="heading"><b>المفضلة</b></div>
      <div id="favList" class="grid"></div>
    </section>

    <section id="search">
      <div class="heading"><b>البحث</b></div>
      <div class="row">
        <input id="q" class="field" placeholder="ابحث عن آية • ذكر • محطة راديو">
        <button class="btn sm" onclick="doSearch()">بحث</button>
      </div>
      <div id="results" class="grid" style="margin-top:10px"></div>
    </section>

    <div class="footer muted">جميع الحقوق محفوظة © مؤسسة ذيب</div>
  </main>

  <div class="mini" id="mini">
    <button class="btn sm" onclick="gotoSection('live')">🎧 البث</button>
    <audio id="miniAudio" controls></audio>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ======== THEME ======== */
function applyTheme(t){
  if(t==='cyan'){ document.documentElement.style.setProperty('--brand','#22d3ee'); }
  else if(t==='violet'){ document.documentElement.style.setProperty('--brand','#8b5cf6'); }
  else{ document.documentElement.style.setProperty('--brand','#0ea37a'); }
  localStorage.setItem('theme', t);
}
document.querySelectorAll('.swatch').forEach(s=>s.onclick=()=>applyTheme(s.dataset.theme));
applyTheme(localStorage.getItem('theme')||'green');

/* ======== ROUTER ======== */
document.querySelectorAll('.nav .tab').forEach(t=>t.onclick=()=>gotoSection(t.getAttribute('data-to')));
function gotoSection(id){
  document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById(id); if(el) el.classList.add('active');
  document.querySelectorAll('.nav .tab').forEach(t=>t.classList.toggle('active', t.getAttribute('data-to')===id));
  window.scrollTo({top:0,behavior:'smooth'});
}
window.addEventListener('hashchange', ()=>{
  const h=(location.hash||'').replace('#',''); if(h) gotoSection(h);
});
if(location.hash){ gotoSection(location.hash.replace('#','')); }

/* ======== HOME (Ayah/Thikr of day) ======== */
(async function(){
  try{
    // Simple ayah: use Al-Quran Cloud random ayah
    const r = await fetch('https://api.alquran.cloud/v1/ayah/random/uthmani');
    const j = await r.json(); document.getElementById('ayahOfDay').textContent = j.data.text;
  }catch(e){ document.getElementById('ayahOfDay').textContent='—'; }
  const thikrBank=[
    "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ، سُبْحَانَ اللَّهِ الْعَظِيمِ",
    "لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ",
    "أستغفر الله وأتوب إليه",
    "حَسْبِيَ اللَّهُ لَا إِلَهَ إِلَّا هُوَ عَلَيْهِ تَوَكَّلْتُ وَهُوَ رَبُّ العَرْشِ العَظِيمِ"
  ];
  document.getElementById('zekrOfDay').textContent = thikrBank[Math.floor(Math.random()*thikrBank.length)];
})();
function speak(text){
  try{ const u = new SpeechSynthesisUtterance(text); u.lang='ar'; speechSynthesis.speak(u);}catch(e){ toast('المتصفح لا يدعم القراءة الصوتية'); }
}

/* ======== PRAYER TIMES ======== */
const locBadge=document.getElementById('locBadge');
document.getElementById('useGeo').onclick=()=>navigator.geolocation.getCurrentPosition(async pos=>{
  const {latitude,longitude}=pos.coords; locBadge.textContent=`${latitude.toFixed(3)}, ${longitude.toFixed(3)}`;
  loadTimings(latitude, longitude);
},()=>alert('لم أستطع الحصول على موقعك'));
async function loadTimings(lat,lon,city=null){
  try{
    const url = city ? `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=&method=5`
                     : `https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=5`;
    const r = await fetch(url); const j = await r.json();
    const t = j.data.timings;
    renderTimes({Fajr:t.Fajr,Dhuhr:t.Dhuhr,Asr:t.Asr,Maghrib:t.Maghrib,Isha:t.Isha});
  }catch(e){ toast('تعذر جلب المواقيت'); }
}
document.getElementById('cityInput').addEventListener('keydown',e=>{ if(e.key==='Enter'){ loadTimings(null,null, e.target.value.trim()); }});

function renderTimes(tims){
  window._lastPrayerTimings = tims;
  const wrap=document.getElementById('timesWrap'); wrap.innerHTML='';
  Object.entries(tims).forEach(([k,v])=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`<b>${k}</b><div class="muted" style="font-size:1.2rem">${v}</div>`;
    wrap.appendChild(div);
  });
  updateCountdown(tims);
  setTimeout(()=>{ if(window.schedulePrayerReminders) window.schedulePrayerReminders(tims); },0);
}
// simple countdown
let cdTimer=null;
function updateCountdown(tims){
  if(cdTimer) clearInterval(cdTimer);
  const order=[['Fajr','الفجر'],['Dhuhr','الظهر'],['Asr','العصر'],['Maghrib','المغرب'],['Isha','العشاء']];
  cdTimer=setInterval(()=>{
    const now=new Date();
    let next=null;
    for(const [k,ar] of order){
      const d=new Date(); const [h,m]=tims[k].split(':').map(Number); d.setHours(h,m,0,0);
      if(d>now){ next={key:k,ar,time:d}; break; }
    }
    if(!next){ // tomorrow Fajr
      const d=new Date(); const [h,m]=tims['Fajr'].split(':').map(Number); d.setDate(d.getDate()+1); d.setHours(h,m,0,0);
      next={key:'Fajr',ar:'الفجر',time:d};
    }
    document.getElementById('nextName').textContent = next.ar;
    const diff=next.time - now;
    const hh=String(Math.floor(diff/3600000)).padStart(2,'0');
    const mm=String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
    const ss=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
    document.getElementById('countdown').textContent=`${hh}:${mm}:${ss}`;
  },1000);
}
// load by IP as fallback (simple)
loadTimings(null,null,'Cairo');

/* ======== REMINDERS (before/after) ======== */
let __reminderTimers=[];
async function ensureNotifyPermission(){
  if(!("Notification" in window)) return 'denied';
  if(Notification.permission==='granted') return 'granted';
  try{ return await Notification.requestPermission(); }catch(e){ return Notification.permission; }
}
async function showNotif(title, body, data){
  try{
    const reg = await navigator.serviceWorker.getRegistration();
    if(reg){
      await reg.showNotification(title, { body, lang:'ar', dir:'rtl',
        icon:'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><path fill=%22%230ea37a%22 d=%22M32 6l10 10h8v34H14V16h8z%22/><path fill=%22%23fff%22 d=%22M22 28h20v18H22z%22/></svg>',
        badge:'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22 fill=%22%230ea37a%22/></svg>',
        vibrate:[120,60,120], tag: data?.tag||'prayer', data
      });
      return;
    }
  }catch(e){}
  if('Notification' in window && Notification.permission==='granted'){
    new Notification(title,{body, lang:'ar', dir:'rtl'});
  }else{
    toast(title + ' — ' + body);
  }
}
function clearReminderTimers(){ __reminderTimers.forEach(id=>clearTimeout(id)); __reminderTimers=[]; }
function hhmmToDate(hhmm){ const [h,m]=hhmm.split(':').map(Number); const d=new Date(); d.setHours(h,m,0,0); return d; }
window.schedulePrayerReminders=function(tims){
  clearReminderTimers();
  const enabled = localStorage.getItem('remindersEnabled')==='true';
  if(!enabled) return;
  const preM = Math.max(1,Math.min(120,parseInt(localStorage.getItem('remindPre')||'15',10)));
  const postM= Math.max(1,Math.min(120,parseInt(localStorage.getItem('remindPost')||'20',10)));
  const map=[['Fajr','الفجر'],['Dhuhr','الظهر'],['Asr','العصر'],['Maghrib','المغرب'],['Isha','العشاء']];
  const now=Date.now();
  map.forEach(([k,ar])=>{
    const base=hhmmToDate(tims[k]); if(base.getTime()<=now) base.setDate(base.getDate()+1);
    const pre=new Date(base.getTime()-preM*60000);
    const post=new Date(base.getTime()+postM*60000);
    const preDelay=pre.getTime()-Date.now(); const postDelay=post.getTime()-Date.now();
    if(preDelay>0){ __reminderTimers.push(setTimeout(()=>showNotif(`اقترب موعد صلاة ${ar}`,'لا تنسَ الاستعداد للصلاة.',{section:'prayer',prayer:ar,kind:'before',tag:'before-'+k}), preDelay)); }
    if(postDelay>0){ __reminderTimers.push(setTimeout(()=>showNotif(`أذكار ما بعد صلاة ${ar}`,'استغفر الله، سبحان الله، الحمد لله، الله أكبر.',{section:'azkar',prayer:ar,kind:'after',tag:'after-'+k}), postDelay)); }
  });
};
(function(){ // UI bind
  const tgl=document.getElementById('remindersToggle');
  const pre=document.getElementById('preMinutes');
  const post=document.getElementById('postMinutes');
  const save=document.getElementById('saveReminders');
  tgl.checked = localStorage.getItem('remindersEnabled')==='true';
  pre.value = parseInt(localStorage.getItem('remindPre')||'15',10);
  post.value = parseInt(localStorage.getItem('remindPost')||'20',10);
  save.onclick=async()=>{
    localStorage.setItem('remindersEnabled', tgl.checked?'true':'false');
    localStorage.setItem('remindPre', String(Math.max(1,Math.min(120,parseInt(pre.value||'15',10)))));
    localStorage.setItem('remindPost',String(Math.max(1,Math.min(120,parseInt(post.value||'20',10)))));
    const p=await ensureNotifyPermission(); if(p!=='granted' && tgl.checked) alert('لم يتم منح إذن الإشعارات');
    if(window._lastPrayerTimings) window.schedulePrayerReminders(window._lastPrayerTimings);
    toast('تم حفظ إعدادات التنبيهات');
  };
})();
if(navigator.serviceWorker){
  navigator.serviceWorker.addEventListener('message', e=>{ const j=e.data||{}; if(j.jump) gotoSection(j.jump); });
}

/* ======== LIVE RADIO ======== */
const stations=[
  {name:'بث الحرم المكي (صوت فقط)', url:'https://qurango.net/radio/makkah'},
  {name:'بث الحرم النبوي (صوت فقط)', url:'https://qurango.net/radio/madina'},
  {name:'إذاعة القرآن الكريم (القاهرة)', url:'https://stream.radiojar.com/8s5u5tpdtwzuv'},
  {name:'إذاعة القرآن السعودية (مكة)', url:'https://stream.radiojar.com/0tpy1h0kxtzuv'},
  {name:'Qurango: Mix Radio', url:'https://qurango.net/radio/mix'},
  {name:'Qurango: أذكار الصباح', url:'https://qurango.net/radio/athkar_sabah'},
  {name:'Qurango: أذكار المساء', url:'https://qurango.net/radio/athkar_masa'}
];
const radioSel=document.getElementById('radioSel');
stations.forEach(s=>{ const o=document.createElement('option'); o.value=s.url; o.textContent=s.name; radioSel.appendChild(o); });

// Default to Haram (Makkah) audio-only stream
const DEFAULT_HARAM = 'https://qurango.net/radio/makkah';
try{
  radioSel.value = DEFAULT_HARAM;
}catch(_){}
const radioEl = document.getElementById('radio');
radioEl.src = radioSel.value || DEFAULT_HARAM;
// Prepare mini-player
document.getElementById('miniAudio').src = radioEl.src;
document.getElementById('mini').classList.add('on');
// Attempt to start playback; browsers may block until a user gesture
radioEl.load();
radioEl.play().catch(()=>{});
// One-time resume on first user interaction (helps iOS/Chrome policies)
const __onceStart = ()=>{
  radioEl.play().catch(()=>{});
  document.getElementById('miniAudio').play().catch(()=>{});
  document.removeEventListener('click', __onceStart, true);
  document.removeEventListener('touchstart', __onceStart, true);
};
document.addEventListener('click', __onceStart, true);
document.addEventListener('touchstart', __onceStart, true);

document.getElementById('playRadio').onclick=()=>{
  const u=document.getElementById('customUrl').value.trim() || radioSel.value;
  const a=document.getElementById('radio'); a.src=u; a.play().catch(()=>toast('تعذر التشغيل — جرّب رابطًا آخر'));
  // mini
  document.getElementById('miniAudio').src=u;
  document.getElementById('mini').classList.add('on');
};

/* ======== MUSHAF (text + full surah audio) ======== */



const reciters = [
  {label:'عبد الباسط (مرتل)', code:'ar.abdulbasitmurattal'},
  {label:'الحصري (مرتل)', code:'ar.husary'},
  {label:'المنشاوي (مرتل)', code:'ar.minshawi'},
  {label:'السديس', code:'ar.abdurrahmaansudais'},
  {label:'الشريم', code:'ar.saoodshuraym'},
  {label:'سعد الغامدي', code:'ar.saadghamdi'},
  {label:'فارس عباد', code:'ar.faresabbad'},
  {label:'ماهر المعيقلي', code:'ar.mahermuaiqly'},
  {label:'مشاري العفاسي', code:'ar.alafasy'}
];



const recSel=document.getElementById('reciterSel');

/* -------- Robust audio resolver -------- */
const HARDCODED_MAP = {
  'ar.husary': ['ar.husary','ar.husarymurattal','ar.husary_64kbps'],
  'ar.minshawi': ['ar.minshawi','ar.minshawi-mujawwad','ar.minshawi_mujawwad'],
  'ar.abdurrahmaansudais': ['ar.abdurrahmaansudais','ar.sudais'],
  'ar.saoodshuraym': ['ar.saoodshuraym','ar.shuraym'],
  'ar.saoodghamdi': ['ar.saoodghamdi','ar.ghamdi'],
  'ar.mahermuaiqly': ['ar.mahermuaiqly','ar.maher-almuaiqly'],
  'ar.abdulbasitmurattal': ['ar.abdulbasitmurattal','ar.abdulbasit'],
  'ar.alafasy': ['ar.alafasy']
};

function unique(arr){ return Array.from(new Set(arr)); }

async function tryPlayUrl(audioEl, url){
  return new Promise((resolve)=>{
    let done=false;
    const onCanPlay = ()=>{ if(!done){ done=true; cleanup(); audioEl.src=url; audioEl.play().then(()=>resolve(true)).catch(()=>resolve(false)); } };
    const onError = ()=>{ if(!done){ done=true; cleanup(); resolve(false);} };
    function cleanup(){ audioEl.removeEventListener('canplay', onCanPlay); audioEl.removeEventListener('error', onError); }
    // Create a temp audio to probe URL to avoid flashing current player
    const probe = new Audio();
    probe.addEventListener('canplay', onCanPlay);
    probe.addEventListener('error', onError);
    probe.src = url;
    // Some browsers need load() to start probing
    try{ probe.load(); }catch(e){}
    // Fallback timeout
    setTimeout(()=>{ if(!done){ done=true; cleanup(); resolve(false);} }, 4000);
  });
}

async function discoverEditionsLike(primary){
  // try to expand candidate codes using editions API (best-effort)
  try{
    const r = await fetch('https://api.alquran.cloud/v1/edition?format=audio');
    const j = await r.json();
    if(!j || !j.data) return [];
    const key = primary.replace('ar.','').replace(/[^a-z]/g,'');
    const names = ['husary','minshawi','sudais','shuraym','ghamdi','maher','muaiqly','abdulbasit','alafasy','fares','abbad'];
    const pool = j.data.filter(e => e.language==='ar');
    return pool
      .filter(e => (e.identifier && (e.identifier.includes(key) || names.some(n=>e.identifier.includes(n)))))
      .map(e => e.identifier);
  }catch(e){ return []; }
}

async function buildCandidates(primary){
  const hard = HARDCODED_MAP[primary] || [primary];
  const discovered = await discoverEditionsLike(primary);
  return unique([...hard, ...discovered]);
}

async function playFullSurahResolved(edition, surah){
  const audioEl = document.getElementById('qAudio');
  const candidates = await buildCandidates(edition);
  for(const ed of candidates){
    const url = `https://cdn.islamic.network/quran/audio-surah/128/${ed}/${surah}.mp3`;
    if(await tryPlayUrl(audioEl, url)) return true;
  }
  // Ultimate fallback
  const fallback = `https://cdn.islamic.network/quran/audio-surah/128/ar.alafasy/${surah}.mp3`;
  if(await tryPlayUrl(audioEl, fallback)){
    toast('تم تشغيل التلاوة بقارئ بديل (العفاسي) لعدم توفر القارئ المختار');
    return true;
  }
  toast('تعذر تشغيل أي تلاوة للسورة المختارة الآن');
  return false;
}

// For per-ayah
async function getAyahAudioUrlResolved(edition, globalAyahNumber){
  const candidates = await buildCandidates(edition);
  for(const ed of candidates){
    const u = `https://cdn.islamic.network/quran/audio/ayah/128/${ed}/${globalAyahNumber}.mp3`;
    // quick probe by constructing Audio
    const ok = await tryPlayUrl(new Audio(), u);
    if(ok) return u;
  }
  const fallback = `https://cdn.islamic.network/quran/audio/ayah/128/ar.alafasy/${globalAyahNumber}.mp3`;
  const ok = await tryPlayUrl(new Audio(), fallback);
  return ok ? fallback : null;
}



// Per-ayah playback (uses global ayah numbers from API response)
let __byAyah = false;
let __ayahList = []; // [{num:number, el:HTMLElement}]
let __ayahIdx = 0;
let __ayahAudio = new Audio();
let __ayahEdition = 'ar.alafasy';

function setAyahHighlight(idx){
  __ayahList.forEach((o,i)=>{
    if(i===idx){ o.el.style.background = 'rgba(34,197,94,.18)'; o.el.scrollIntoView({block:'center', behavior:'smooth'}); }
    else{ o.el.style.background = 'transparent'; }
  });
}

async function getAyahAudioUrl(edition, globalAyahNumber){ return await getAyahAudioUrlResolved(edition, globalAyahNumber); }

async function playAyahAt(idx){
  if(idx<0 || idx>=__ayahList.length) return;
  __ayahIdx = idx;
  setAyahHighlight(__ayahIdx);
  const n = __ayahList[__ayahIdx].num;
  const url = await getAyahAudioUrl(__ayahEdition, n);
  if(!url){ toast('تعذر جلب ملف الآية الصوتي'); return; }
  __ayahAudio.src = url;
  try{ await __ayahAudio.play(); }catch(e){ toast('لم يتمكن المتصفح من تشغيل الصوت'); }
  // Fetch tafsir if enabled
  updateTafsirForAyah(n).catch(()=>{});
}

function stopByAyah(){ try{ __ayahAudio.pause(); }catch(e){} }

function nextAyah(){ if(__ayahIdx+1<__ayahList.length) playAyahAt(__ayahIdx+1); }

__ayahAudio.addEventListener('ended', ()=>{
  if(__byAyah) nextAyah();
});

async function updateTafsirForAyah(globalAyahNumber){
  const sel = document.getElementById('tafsirSel');
  const box = document.getElementById('tafsirBox');
  const content = document.getElementById('tafsirContent');
  if(!sel || !box || !content) return;
  if(!sel.value){ box.style.display='none'; return; }
  box.style.display='block';
  content.textContent = '… جاري جلب التفسير …';
  try{
    const r = await fetch(`https://api.alquran.cloud/v1/ayah/${globalAyahNumber}/${sel.value}`);
    const j = await r.json();
    if(j && j.data && j.data.text){
      content.textContent = j.data.text;
    }else{
      content.innerHTML = '<span class="muted">تعذر جلب التفسير لهذه الآية.</span>';
    }
  }catch(e){
    content.innerHTML = '<span class="muted">تعذر جلب التفسير لهذه الآية.</span>';
  }
}

reciters.forEach(r=>{ const o=document.createElement('option'); o.value=r.code; o.textContent=r.label; recSel.appendChild(o); });
const surSel=document.getElementById('surahSel');
(async function(){
  const sur = await fetch('https://api.alquran.cloud/v1/surah').then(r=>r.json()).catch(()=>null);
  if(sur && sur.data){
    sur.data.forEach(s=>{ const o=document.createElement('option'); o.value=s.number; o.textContent = s.number + ' - ' + s.name; surSel.appendChild(o); });
  }else{
    for(let i=1;i<=114;i++){ const o=document.createElement('option'); o.value=i; o.textContent='سورة #' + i; surSel.appendChild(o); }
  }
})();


async function playSurahAsAyahChain(edition, surahNumber){
  try{
    const t = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/ar.uthmani`).then(r=>r.json());
    const ayahs = (t && t.data && t.data.ayahs) ? t.data.ayahs : [];
    const container = document.getElementById('qText');
    container.innerHTML = ayahs.map((a,i)=>`<span class="ayah" data-num="${a.number}" data-idx="${i}" style="padding:.15rem .25rem;display:inline-block;cursor:pointer">${a.text} <span class="muted">﴿${a.numberInSurah}﴾</span></span>`).join(' ');
    __ayahList = Array.from(container.querySelectorAll('.ayah')).map(el=>({num: parseInt(el.getAttribute('data-num'),10), el}));
    __byAyah = true;
    __ayahEdition = edition;
    if(__ayahList.length>0){
      await playAyahAt(0);
      // Pause full-surah audio if anything
      try{ document.getElementById('qAudio').pause(); }catch(e){}
      toast('تم تشغيل السورة آية-بآية تلقائيًا لعدم توفر ملف السورة الكاملة للقارئ المختار');
      return true;
    }
  }catch(e){}
  return false;
}

document.getElementById('playSurah').onclick=async()=>{
  const s=surSel.value, ed=recSel.value;
  __byAyah = !!document.getElementById('byAyah').checked;
  __ayahEdition = ed;

  try{
    const t = await fetch(`https://api.alquran.cloud/v1/surah/${s}/ar.uthmani`).then(r=>r.json());
    const ayahs = t.data.ayahs || [];
    // Render ayahs as individual spans with data-number
    const container = document.getElementById('qText');
    container.innerHTML = ayahs.map((a,i)=>`<span class="ayah" data-num="${a.number}" data-idx="${i}" style="padding:.15rem .25rem;display:inline-block;cursor:pointer">${a.text} <span class="muted">﴿${a.numberInSurah}﴾</span></span>`).join(' ');
    __ayahList = Array.from(container.querySelectorAll('.ayah')).map(el=>({num: parseInt(el.getAttribute('data-num'),10), el}));
    container.querySelectorAll('.ayah').forEach(el=>{
      el.addEventListener('click', ()=>{
        const idx = parseInt(el.getAttribute('data-idx'),10);
        if(__byAyah){
          stopByAyah();
          playAyahAt(idx);
        }else{
          // jump tafsir for clicked ayah even if not by-ayah
          updateTafsirForAyah(parseInt(el.getAttribute('data-num'),10));
        }
      });
    });
  }catch(e){
    document.getElementById('qText').textContent='تعذر جلب النص';
  }

  if(__byAyah){
    // start verse-by-verse
    const firstIdx = 0;
    if(__ayahList.length>0) await playAyahAt(firstIdx);
    // also pause any full-surah audio
    try{ document.getElementById('qAudio').pause(); }catch(e){}
  }else{
    // full surah playback with robust fallback
    if(!(await playFullSurahResolved(ed, s))){ await playSurahAsAyahChain(ed, s); }
  }
};


/* ======== AZKAR (dataset from حصن المسلم + الرقية + النوم + الوضوء) ======== */
const AZKAR = {
  morning: [
    {text:"أَعُوذُ بِاللهِ مِنَ الشَّيْطَانِ الرَّجِيمِ • اللّهُ لاَ إِلَـهَ إِلاَّ هُوَ الْحَيُّ الْقَيُّومُ ... وَهُوَ الْعَلِيُّ الْعَظِيمُ (آية الكرسي).", repeat:1, virtue:"من قالها حين يصبح أُجير من الجن حتى يمسي."},
    {text:"قُلْ هُوَ اللَّهُ أَحَدٌ", repeat:3},
    {text:"قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ", repeat:3},
    {text:"قُلْ أَعُوذُ بِرَبِّ النَّاسِ", repeat:3},
    {text:"أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ ... وَعَذَابٍ فِي القَبْرِ.", repeat:1},
    {text:"سيد الاستغفار: اللّهـمّ أنت ربي لا إله إلا أنت ... اغفر لي فإنه لا يغفر الذنوب إلا أنت.", repeat:1},
    {text:"رَضِيتُ بالله ربًّا وبالإسلام دينًا وبمحمد ﷺ نبيًّا.", repeat:3},
    {text:"اللّهُمَّ ما أَصْبَحَ بي من نعمةٍ ... فلك الحمد ولك الشكر.", repeat:1},
    {text:"حَسْبِيَ اللَّهُ لا إِلَهَ إِلا هُوَ عَلَيْهِ تَوَكَّلْتُ وَهُوَ رَبُّ العَرْشِ العَظِيمِ.", repeat:7},
    {text:"بِسْمِ الله الذي لا يضرّ مع اسمه شيء في الأرض ولا في السماء وهو السميع العليم.", repeat:3},
    {text:"سُبْحانَ اللهِ وبِحَمْدِهِ عددَ خلقِه ورضا نفسِه وزِنةَ عرشِه ومِدادَ كلماتِه.", repeat:3},
    {text:"اللّهمّ عافني في بدني، اللّهمّ عافني في سمعي، اللّهمّ عافني في بصري، لا إله إلا أنت.", repeat:3},
    {text:"اللّهمّ إنّي أسألك العفوَ والعافيةَ في الدنيا والآخرة ...", repeat:1},
    {text:"يا حي يا قيوم برحمتك أستغيث أصلح لي شأني كلّه ولا تكلني إلى نفسي طرفة عين.", repeat:3},
    {text:"اللّهُمَّ عَالِمَ الغيب والشّهادة ... أعوذ بك من شرّ نفسي ومن شرّ الشيطان وشِرْكِهِ.", repeat:1},
    {text:"الصلاة على النبي ﷺ", repeat:10},
    {text:"لا إله إلا الله وحده لا شريك له ...", repeat:100},
    {text:"سُبْحانَ اللهِ وبِحَمْدِهِ.", repeat:100},
    {text:"أستغفر الله وأتوب إليه.", repeat:100}
  ],
  evening: [
    {text:"المعوذات (الإخلاص، الفلق، الناس) كل سورة 3 مرات.", repeat:3},
    {text:"خواتيم سورة البقرة (آمَنَ الرَّسول ...)", repeat:1},
    {text:"آية الكرسي.", repeat:1},
    {text:"أَمْسَيْنَا وَأَمْسَى المُلْكُ لِلَّهِ ...", repeat:1},
    {text:"سيد الاستغفار ...", repeat:1},
    {text:"رَضِيتُ بالله ربًّا ...", repeat:3},
    {text:"اللّهُمَّ ما أمسى بي من نعمة ...", repeat:1},
    {text:"حَسْبِيَ اللّه ...", repeat:7},
    {text:"بِسْمِ الله الذي لا يضرّ ...", repeat:3},
    {text:"سُبْحانَ اللهِ وبِحَمْدِهِ عددَ خلقِه ...", repeat:3},
    {text:"اللّهمّ عافني في بدني ...", repeat:3},
    {text:"اللّهمّ إنّي أسألك العفو والعافية ...", repeat:1},
    {text:"يا حي يا قيوم ...", repeat:3},
    {text:"الصلاة على النبي ﷺ", repeat:10},
    {text:"لا إله إلا الله وحده لا شريك له ...", repeat:100},
    {text:"سُبْحانَ اللهِ وبِحَمْدِهِ.", repeat:100},
    {text:"أستغفر الله وأتوب إليه.", repeat:100}
  ],
  afterSalah: [
    {text:"أستغفر الله (3) • اللهم أنت السلام ومنك السلام تباركت يا ذا الجلال والإكرام.", repeat:1},
    {text:"لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير ...", repeat:1},
    {text:"التسبيح: سبحان الله (33) • الحمد لله (33) • الله أكبر (33) ثم تمام المائة: لا إله إلا الله ...", repeat:1},
    {text:"آية الكرسي • الإخلاص والمعوذتان (مرة وبعد الفجر والمغرب ثلاثًا).", repeat:1}
  ],
  ruqyah: [
    {text:"الفاتحة • أول البقرة (1-4) • آيات: 20، 60، 69 من البقرة • آية السحر (102) • آية الكرسي • آخر البقرة (285-286) • النساء 32 و54 • الأنعام 103 • التوبة 55 • يوسف 67 • هود 37 • الحجر 16-18 • طه 131 • القصص 79 • الكهف 39 • الصافات 88-90 • الفتح 15 • الملك 1-4 • القلم 1-5 و 51 • الطور 48 • المنافقون 4 • الإنسان 6 • التوبة 14-15 • يونس 57 • النحل 68-69 • الإسراء 82 • الشعراء 80 • فصلت 44 • الإخلاص • الفلق • الناس.", repeat:1},
    {text:"اللَّهُمَّ إِنِّي عَبْدُكَ ابنُ عبدِكَ ابنُ أَمَتِكَ ... أَنْ تَجْعَلَ القُرْآنَ رَبِيعَ قَلْبِي ...", repeat:1},
    {text:"تحصَّنتُ بالله الذي لا إله إلا هو ... حسبي الله ونعم الوكيل ...", repeat:1},
    {text:"اللهم رحمتك نرجو فلا تكلني إلى نفسي طرفة عين ...", repeat:1},
    {text:"اللهم اصرف عني حرَّ العين وبردها ووصبها.", repeat:1},
    {text:"اللهم رب الناس أذهب البأس واشفِ أنت الشافي ...", repeat:1},
    {text:"بسم الله أرقي نفسي من كل شيء يؤذيني ...", repeat:1}
  ],
  sleep: [
    {text:"جمع الكفين والنفث فيهما وقراءة الإخلاص والفلق والناس ثلاثًا ثم مسح الجسد.", repeat:3},
    {text:"آية الكرسي.", repeat:1},
    {text:"خواتيم البقرة (آمن الرسول ...).", repeat:1},
    {text:"باسمك ربي وضعتُ جنبي ...", repeat:1},
    {text:"اللهم إنك خلقت نفسي ... أسألك العافية.", repeat:1},
    {text:"اللهم قني عذابك يوم تبعث عبادك.", repeat:1},
    {text:"باسمك اللهم أموت وأحيا.", repeat:1},
    {text:"تسبيح: 33 • تحميد: 33 • تكبير: 34.", repeat:1},
    {text:"اللهم رب السموات السبع ورب الأرض ... اقضِ عنا الدين وأغننا من الفقر.", repeat:1},
    {text:"الحمد لله الذي أطعمنا وسقانا وكفانا وآوانا ...", repeat:1},
    {text:"اللهم عالم الغيب والشهادة ...", repeat:1},
    {text:"قراءة (الم تنزيل) السجدة و(تبارك الذي بيده الملك).", repeat:1},
    {text:"اللهم أسلمت نفسي إليك ... آمنت بكتابك الذي أنزلت ونبيك الذي أرسلت.", repeat:1}
  ],
  wudu: [
    {text:"قبل الوضوء: التسمية (بِسْمِ الله).", repeat:1},
    {text:"بعد الوضوء: أشهد أن لا إله إلا الله وحده لا شريك له وأشهد أن محمدًا عبده ورسوله، اللهم اجعلني من التوابين واجعلني من المتطهرين.", repeat:1},
    {text:"(سُبحانك اللهم وبحمدك، أشهد أن لا إله إلا أنت، أستغفرك وأتوب إليك).", repeat:1}
  ]
};
const azList=document.getElementById('azList'); const azCat=document.getElementById('azCat');
function renderAzkar(cat){
  azList.innerHTML='';
  (AZKAR[cat]||[]).forEach((z,idx)=>{
    const d=document.createElement('div'); d.className='card';
    d.innerHTML = `<div class="heading"><b>#${idx+1}</b><button class="btn sm" data-fav="1">⭐</button></div>
      <p style="line-height:2">${z.text}</p>
      <div class="row"><span class="pill">التكرار: <b>${z.repeat||1}</b></span>
        <button class="btn sm" data-play="1">تشغيل</button>
        <button class="btn sm" data-share="1">مشاركة</button>
      </div>`;
    d.querySelector('[data-play]').onclick=()=>speak(z.text);
    d.querySelector('[data-share]').onclick=()=>{
      const t = z.text; if(navigator.share){ navigator.share({text:t}).catch(()=>{}); }
      else{ navigator.clipboard.writeText(t); toast('تم نسخ الذكر'); }
    };
    d.querySelector('[data-fav]').onclick=()=>saveFav({type:'zekr', cat, idx, text:z.text});
    azList.appendChild(d);
  });
}
azCat.onchange=()=>renderAzkar(azCat.value);
renderAzkar('morning');

/* ======== FAV ======== */
function saveFav(item){
  const arr=JSON.parse(localStorage.getItem('fav')||'[]'); arr.push(item); localStorage.setItem('fav', JSON.stringify(arr));
  toast('أُضيف إلى المفضلة');
  renderFav();
}
function renderFav(){
  const area=document.getElementById('favList'); area.innerHTML='';
  const arr=JSON.parse(localStorage.getItem('fav')||'[]');
  arr.forEach((it,i)=>{
    const d=document.createElement('div'); d.className='card'; d.innerHTML=`<div class="heading"><b>${it.type==='zekr'?'ذكر':'عنصر'}</b><button class="btn sm" data-del="${i}">حذف</button></div><p>${it.text||it.title||''}</p>`;
    d.querySelector('[data-del]').onclick=()=>{ const x=JSON.parse(localStorage.getItem('fav')||'[]'); x.splice(i,1); localStorage.setItem('fav',JSON.stringify(x)); renderFav(); };
    area.appendChild(d);
  });
}
renderFav();

/* ======== SEARCH ======== */
function doSearch(){
  const q=document.getElementById('q').value.trim(); const res=document.getElementById('results'); res.innerHTML='';
  if(!q) return;
  const add=(title, text)=>{ const d=document.createElement('div'); d.className='card'; d.innerHTML=`<div class="heading"><b>${title}</b></div><p>${text}</p>`; res.appendChild(d); };
  // azkar
  Object.entries(AZKAR).forEach(([k,arr])=>arr.forEach(z=>{ if(z.text.includes(q)) add('ذكر من '+k, z.text);}));
  // stations
  stations.forEach(s=>{ if(s.name.includes(q)) add('محطة إذاعية', s.name+' — '+s.url); });
}

/* ======== TOAST ======== */
function toast(t){ const el=document.getElementById('toast'); el.textContent=t; el.classList.add('on'); setTimeout(()=>el.classList.remove('on'), 2400);}

/* ======== SW (offline) ======== */
if('serviceWorker' in navigator){
  const code = `
    const CACHE='onefile-v5';
    self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); self.skipWaiting(); });
    self.addEventListener('activate',e=>{ e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))); self.clients.claim(); });
    self.addEventListener('fetch',e=>{
      e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).then(res=>{
        if(e.request.mode!=='navigate') return res;
        const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request, copy)); return res;
      }).catch(()=>caches.match('./'))));
    });
    self.addEventListener('notificationclick', (event)=>{
      event.notification.close();
      const dest = (event.notification.data && event.notification.data.section) || 'prayer';
      event.waitUntil(self.clients.matchAll({type:'window', includeUncontrolled:true}).then(list=>{
        for(const client of list){ client.postMessage && client.postMessage({jump: dest}); if('focus' in client) return client.focus(); }
        if(self.clients.openWindow) return self.clients.openWindow('./#'+dest);
      }));
    });
  `;
  const blob = new Blob([code], {type:'text/javascript'});
  const url = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url);
}
</script>
</body>
</html>
